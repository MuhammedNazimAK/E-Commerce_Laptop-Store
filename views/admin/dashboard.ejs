<%- include("../partials/admin/header") %>
<%- include("../partials/admin/search") %>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Dashboard</h2>
            <p>Whole data about your business here</p>
        </div>
        <div>
            <a href="/admin/sales-report" class="btn btn-primary"><i class="text-muted material-icons md-post_add"></i>Create report</a>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-primary-light"><i class="text-primary material-icons md-monetization_on"></i></span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Revenue</h6>
                        <span id="totalRevenue">Loading...</span>
                        <span class="text-sm">
                            Shipping fees are not included
                        </span>
                    </div>
                </article>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-success-light"><i class="text-success material-icons md-local_shipping"></i></span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Orders</h6>
                        <span id="totalOrders">Loading...</span>
                        <span class="text-sm">
                            Excluding orders in transit
                        </span>
                    </div>
                </article>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-warning-light"><i class="text-warning material-icons md-qr_code"></i></span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Products</h6>
                        <span id="totalProducts">Loading...</span>
                        <span class="text-sm">
                            In <span id="totalCategories">Loading...</span> Categories
                        </span>
                    </div>
                </article>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-info-light"><i class="text-info material-icons md-shopping_basket"></i></span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Monthly Earning</h6>
                        <span id="monthlyEarning">Loading...</span>
                        <span class="text-sm">
                            Based on your local time.
                        </span>
                    </div>
                </article>
            </div>
        </div>
    </div>
    <!-- <div class="row">
        <div class="col-xl-8 col-lg-12">
            <div class="card mb-4">
                <article class="card-body">
                    <h5 class="card-title">Sale statistics</h5>
                    <canvas id="myChart" height="120px"></canvas>
                </article>
            </div>
        </div>
        <div class="col-xl-4 col-lg-12">
            <div class="card mb-4">
                <article class="card-body">
                    <h5 class="card-title">Revenue Base on Area</h5>
                    <canvas id="myChart2" height="217"></canvas>
                </article>
            </div>
        </div>
    </div> -->
    <div class="card mb-4">
        <header class="card-header">
            <h4 class="card-title">Latest orders</h4>
            <div class="row align-items-center">
                <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                    <select id="categoryFilter" class="form-select select-nice">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-2 col-6">
                    <input type="date" id="dateFilter" class="form-control">
                </div>
                <div class="col-md-2 col-6">
                    <select id="statusFilter" class="form-select select-nice">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Processing">Processing</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Return Requested">Return Requested</option>
                    </select>
                </div>
            </div>
        </header>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table align-middle table-nowrap mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="align-middle" scope="col">Order ID</th>
                            <th class="align-middle" scope="col">Billing Name</th>
                            <th class="align-middle" scope="col">Date</th>
                            <th class="align-middle" scope="col">Total</th>
                            <th class="align-middle" scope="col">Payment Status</th>
                            <th class="align-middle" scope="col">Payment Method</th>
                            <th class="align-middle" scope="col">View Details</th>
                        </tr>
                    </thead>
                    <tbody id="latestOrdersTable">
                        <!-- Latest orders will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="pagination-area mt-30 mb-50">
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-start" id="pagination">
                <!-- Pagination will be dynamically inserted here -->
            </ul>
        </nav>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // JavaScript code to fetch and update dashboard data
    document.addEventListener('DOMContentLoaded', function() {
        fetchDashboardData();
        fetchLatestOrders();
        setupEventListeners();
    });

    function fetchDashboardData() {
        axios.get('/admin/dashboard-data')
            .then(function (response) {
                const data = response.data;
                document.getElementById('totalRevenue').textContent = '₹' + data.totalRevenue.toFixed(2);
                document.getElementById('totalOrders').textContent = data.totalOrders;
                document.getElementById('totalProducts').textContent = data.totalProducts;
                document.getElementById('totalCategories').textContent = data.totalCategories;
                document.getElementById('monthlyEarning').textContent = '₹' + data.monthlyEarning.toFixed(2);
                
                // Update charts
                updateSaleStatistics(data.saleStatistics);
                updateRevenueByArea(data.revenueByArea);
            })
            .catch(function (error) {
                console.error('Error fetching dashboard data:', error);
            });
    }

    function fetchLatestOrders(page = 1, category = '', date = '', status = '') {
        axios.get(`/admin/latest-orders?page=${page}&category=${category}&date=${date}&status=${status}`)
            .then(function (response) {
                const { orders, totalPages, currentPage } = response.data;
                updateLatestOrdersTable(orders);
                updatePagination(totalPages, currentPage);
            })
            .catch(function (error) {
                console.error('Error fetching latest orders:', error);
            });
    }

    function updateLatestOrdersTable(orders) {
        const tableBody = document.getElementById('latestOrdersTable');
        tableBody.innerHTML = '';
        orders.forEach(order => {
            const row = `
                <tr>
                    <td><a href="#" class="fw-bold">${order.orderId}</a></td>
                    <td>${order.billingName}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>₹${order.total.toFixed(2)}</td>
                    <td><span class="badge badge-pill badge-soft-${getStatusColor(order.status)}">${order.status}</span></td>
                    <td><i class="material-icons md-payment font-xxl text-muted mr-5"></i> ${order.paymentMethod}</td>
                    <td><a href="/orders/${order._id}" class="btn btn-xs"> View details</a></td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    function updatePagination(totalPages, currentPage) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
    }

    function setupEventListeners() {
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('dateFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('pagination').addEventListener('click', handlePaginationClick);
    }

    function applyFilters() {
        const category = document.getElementById('categoryFilter').value;
        const date = document.getElementById('dateFilter').value;
        const status = document.getElementById('statusFilter').value;
        fetchLatestOrders(1, category, date, status);
    }

    function handlePaginationClick(event) {
        event.preventDefault();
        if (event.target.tagName === 'A') {
            const page = event.target.getAttribute('data-page');
            const category = document.getElementById('categoryFilter').value;
            const date = document.getElementById('dateFilter').value;
            const status = document.getElementById('statusFilter').value;
            fetchLatestOrders(page, category, date, status);
        }
    }

    function getStatusColor(status) {
        const colors = {
            'Pending': 'warning',
            'Confirmed': 'info',
            'Processing': 'primary',
            'Shipped': 'secondary',
            'Delivered': 'success',
            'Cancelled': 'danger',
            'Return Requested': 'dark'
        };
        return colors[status] || 'light';
    }

    function updateSaleStatistics(data) {
        const ctx = document.getElementById('myChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Sales',
                    data: data.values,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function updateRevenueByArea(data) {
        const ctx = document.getElementById('myChart2').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }
</script>

<%- include("../partials/admin/footer") %>